# METABEGIN
# X-Env-Layer-Name: masjidconnect-display
# X-Env-Layer-Desc: MasjidConnect Display App â€” Node server + Chromium kiosk (X11/xinit).
#   Expects app archive at IGconf_masjidconnect_app_archive (tar.gz from npm run package).
# X-Env-Layer-Requires: rpi-user-credentials,systemd-net-min
#
# X-Env-VarPrefix: masjidconnect
# X-Env-Var-app_archive: app/masjidconnect-display.tar.gz
# X-Env-Var-app_archive-Desc: Path to masjidconnect-display-*.tar.gz (relative to -S or absolute)
# X-Env-Var-app_archive-Required: n
# X-Env-Var-app_archive-Set: y
# X-Env-Var-wifi_ssid: Optional. WiFi SSID to bake into image (or use wifi.conf in source root).
# X-Env-Var-wifi_password: Optional. WiFi passphrase (or use wifi.conf).
# X-Env-Var-wifi_country: Optional. Two-letter country code (e.g. GB). Default GB.
# METAEND
---
mmdebstrap:
  packages:
    - chromium
    - dbus
    - libgl1-mesa-dri
    - openssh-server
    - curl
    - ca-certificates
    - plymouth
    - initramfs-tools
    - xserver-xorg-core
    - xserver-xorg
    - xinit
    - x11-xserver-utils
    - unclutter
    - kbd
    - wpasupplicant
    - iw
    - raspi-config
  customize-hooks:
    # Install Node.js 20 from NodeSource (build host needs network)
    - |
      chroot $1 /bin/bash -c 'curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && apt-get install -y nodejs' || true
    # Extract app archive to /opt/masjidconnect (path relative to -S or absolute). One line so YAML does not parse colons as map; use |- so it stays a string.
    - |
      ARCHIVE="${IGconf_masjidconnect_app_archive:-app/masjidconnect-display.tar.gz}"; [ -z "$ARCHIVE" ] && { echo "MasjidConnect app archive path not set (IGconf_masjidconnect_app_archive)"; exit 1; }; [ ! -f "$ARCHIVE" ] && { echo "MasjidConnect app archive not found: $ARCHIVE"; exit 1; }; mkdir -p "$1/opt/masjidconnect"; cp "$ARCHIVE" "$1/tmp/masjidconnect-app.tar.gz"; chroot "$1" /bin/bash -c "tar -xzf /tmp/masjidconnect-app.tar.gz -C /opt/masjidconnect && rm /tmp/masjidconnect-app.tar.gz"
    # Ownership (pi user is typically 1000:1000)
    - chroot $1 /bin/bash -c 'chown -R 1000:1000 /opt/masjidconnect'
    - chroot $1 /bin/bash -c 'chmod +x /opt/masjidconnect/deploy/xinitrc-kiosk /opt/masjidconnect/deploy/start-kiosk-x11.sh /opt/masjidconnect/deploy/start-kiosk-now.sh /opt/masjidconnect/deploy/wifi-setup-server.mjs /opt/masjidconnect/deploy/update-from-github.sh 2>/dev/null || true'
    # Deploy overlay: copy kiosk scripts from repo so image has them even if the app archive was built before they were added.
    - |
      if [ -d "${SRCROOT}/deploy-overlay" ]; then
        chroot "$1" mkdir -p /opt/masjidconnect/deploy
        for f in "${SRCROOT}"/deploy-overlay/*; do
          [ -f "$f" ] && cp "$f" "$1/opt/masjidconnect/deploy/" && chroot "$1" chmod +x "/opt/masjidconnect/deploy/$(basename "$f")"
        done
      fi
    # Kiosk user needs render/video for X11/Chromium GPU. Base layer creates user pi (rpi-user-credentials).
    - chroot $1 /bin/bash -c 'getent group render >/dev/null || groupadd -r render; getent group video >/dev/null || groupadd -r video; usermod -aG render,video pi'
    # Set a known default password for the first user (UID 1000) so SSH works when Pi Imager cannot apply OS customisation to custom images.
    - |
      chroot $1 /bin/bash -c 'u=$(getent passwd 1000 | cut -d: -f1); [ -n "$u" ] && echo "${u}:masjidconnect" | chpasswd'
    # Ensure KMS (vc4) and GPU memory for X11/Chromium on RPi 3/4/5; disable early RPI splash
    - |
      CFG="$1/boot/firmware/config.txt"
      [ -f "$CFG" ] || CFG="$1/boot/config.txt"
      if [ -f "$CFG" ]; then
        grep -q "^dtoverlay=vc4-kms-v3d" "$CFG" || echo "dtoverlay=vc4-kms-v3d" >> "$CFG"
        grep -q "^gpu_mem=" "$CFG" && sed -i 's/^gpu_mem=.*/gpu_mem=128/' "$CFG" || echo "gpu_mem=128" >> "$CFG"
        grep -q "^disable_splash=" "$CFG" || echo "disable_splash=1" >> "$CFG"
        grep -q "^disable_overscan=" "$CFG" && sed -i 's/^disable_overscan=.*/disable_overscan=1/' "$CFG" || echo "disable_overscan=1" >> "$CFG"
      fi
    # Disable HDMI overscan (KMS) so display is not cut off on TVs
    - chroot $1 raspi-config nonint do_overscan_kms 1 1 || true
    # Silent boot: redirect console to tty2 so no kernel/init text on tty1 (X11 kiosk uses tty1)
    - |
      CMDLINE="$1/boot/firmware/cmdline.txt"
      [ -f "$CMDLINE" ] || CMDLINE="$1/boot/cmdline.txt"
      if [ -f "$CMDLINE" ]; then
        line=$(cat "$CMDLINE")
        for param in quiet loglevel=0 logo.nologo console=tty2; do
          [[ " $line " = *" $param "* ]] || line="$line $param"
        done
        echo "$line" > "$CMDLINE"
      fi
    # Xorg: vc4 OutputClass so Pi 4/5 don't hit "Cannot run in framebuffer mode" (modesetting needs PrimaryGPU).
    - mkdir -p "$1/etc/X11/xorg.conf.d" && cp "${SRCROOT}/layer/xorg.conf.d/99-vc4.conf" "$1/etc/X11/xorg.conf.d/"
    # Install display server systemd unit (run as UID 1000 so Pi Imager custom user e.g. mcadmin works)
    - cp $1/opt/masjidconnect/deploy/masjidconnect-display.service $1/etc/systemd/system/ && sed -i 's/^User=pi$/User=1000/' "$1/etc/systemd/system/masjidconnect-display.service" && sed -i 's/^Group=pi$/Group=1000/' "$1/etc/systemd/system/masjidconnect-display.service"
    # Autologin on tty1 so kiosk runs in a user session (Xorg can then open vt1). No mask of getty@tty1.
    - |
      U=$(chroot "$1" getent passwd 1000 | cut -d: -f1)
      [ -n "$U" ] && mkdir -p "$1/etc/systemd/system/getty@tty1.service.d" && sed "s/AUTOLOGIN_USER/$U/" "${SRCROOT}/layer/getty@tty1.service.d/autologin.conf.tpl" > "$1/etc/systemd/system/getty@tty1.service.d/autologin.conf"
    # PAM: allow passwordless console login on tty1 for first user (so autologin never prompts for password).
    - |
      U=$(chroot "$1" getent passwd 1000 | cut -d: -f1)
      if [ -n "$U" ] && [ -f "$1/etc/pam.d/login" ]; then
        LINE="auth sufficient pam_succeed_if.so user = $U tty = tty1"
        grep -qF "pam_succeed_if.so user = $U tty = tty1" "$1/etc/pam.d/login" || { echo "$LINE" | cat - "$1/etc/pam.d/login" > "$1/etc/pam.d/login.tmp" && mv "$1/etc/pam.d/login.tmp" "$1/etc/pam.d/login"; }
      fi
    # Append kiosk start to UID 1000 .profile (console tty1 only)
    - |
      chroot "$1" /bin/bash -c 'H=$(getent passwd 1000 | cut -d: -f6); [ -n "$H" ] && { touch "$H/.profile"; echo "" >> "$H/.profile"; echo "# MasjidConnect kiosk (console only)" >> "$H/.profile"; echo "[ \"\$(tty)\" = \"/dev/tty1\" ] 2>/dev/null && exec /opt/masjidconnect/deploy/start-kiosk-x11.sh" >> "$H/.profile"; chown 1000:1000 "$H/.profile"; }'
    # Keep getty@tty2 masked so kernel console stays on tty2
    - ln -sf /dev/null "$1/etc/systemd/system/getty@tty2.service"
    # Install kiosk setup (adds UID 1000 to render/video at boot) and X11 kiosk unit
    - cp "${SRCROOT}/layer/masjidconnect-kiosk-setup.service" "$1/etc/systemd/system/"
    - cp "${SRCROOT}/layer/masjidconnect-console-vt1.service" "$1/etc/systemd/system/"
    - cp "${SRCROOT}/layer/kiosk-x11.service.tpl" "$1/etc/systemd/system/masjidconnect-kiosk.service"
    - $BDEBSTRAP_HOOKS/enable-units "$1" masjidconnect-kiosk-setup masjidconnect-console-vt1 masjidconnect-display
    # Custom boot splash: copy rpi-image/assets/splash.png into Plymouth pix theme if present
    - |
      if [ -f "${SRCROOT}/assets/splash.png" ]; then
        mkdir -p "$1/usr/share/plymouth/themes/pix"
        cp "${SRCROOT}/assets/splash.png" "$1/usr/share/plymouth/themes/pix/splash.png"
        chroot "$1" /bin/bash -c 'update-initramfs -u' || true
      fi
    # Optional background image (e.g. for in-app or loading); copy to /opt/masjidconnect for app use
    - |
      if [ -f "${SRCROOT}/assets/background.png" ]; then
        cp "${SRCROOT}/assets/background.png" "$1/opt/masjidconnect/background.png"
        chroot "$1" chown 1000:1000 /opt/masjidconnect/background.png
      fi
    # Optional WiFi: if wifi.conf exists in source root (or IGconf vars set), configure wpa_supplicant for wlan0.
    # wifi.conf format: one line each of SSID=..., PASSWORD=..., COUNTRY=... (COUNTRY default GB).
    - |
      WIFI_SSID=""
      WIFI_PASSWORD=""
      WIFI_COUNTRY="GB"
      if [ -f "${SRCROOT}/wifi.conf" ]; then
        while IFS= read -r line; do
          case "$line" in
            SSID=*)    WIFI_SSID="${line#SSID=}" ;;
            PASSWORD=*) WIFI_PASSWORD="${line#PASSWORD=}" ;;
            COUNTRY=*) WIFI_COUNTRY="${line#COUNTRY=}" ;;
          esac
        done < "${SRCROOT}/wifi.conf"
      fi
      [ -n "${IGconf_masjidconnect_wifi_ssid:-}" ] && WIFI_SSID="${IGconf_masjidconnect_wifi_ssid}"
      [ -n "${IGconf_masjidconnect_wifi_password:-}" ] && WIFI_PASSWORD="${IGconf_masjidconnect_wifi_password}"
      [ -n "${IGconf_masjidconnect_wifi_country:-}" ] && WIFI_COUNTRY="${IGconf_masjidconnect_wifi_country}"
      if [ -n "$WIFI_SSID" ] && [ -n "$WIFI_PASSWORD" ]; then
        mkdir -p "$1/etc/wpa_supplicant"
        printf 'ctrl_interface=/run/wpa_supplicant\nupdate_config=1\ncountry=%s\n' "$WIFI_COUNTRY" > "$1/etc/wpa_supplicant/wpa_supplicant-wlan0.conf"
        printf '%s' "$WIFI_PASSWORD" | chroot "$1" wpa_passphrase "$WIFI_SSID" - >> "$1/etc/wpa_supplicant/wpa_supplicant-wlan0.conf"
        chroot "$1" chmod 600 /etc/wpa_supplicant/wpa_supplicant-wlan0.conf
        mkdir -p "$1/etc/systemd/network"
        printf '[Match]\nName=wlan0\n\n[Network]\nDHCP=yes\n' > "$1/etc/systemd/network/25-wlan0.network"
        chroot "$1" systemctl enable wpa_supplicant@wlan0.service
      fi
    # Allow first user (pi) to run WiFi setup server as root without password (for on-device WiFi GUI when no internet).
    - |
      U=$(chroot "$1" getent passwd 1000 | cut -d: -f1)
      if [ -n "$U" ]; then
        echo "${U} ALL=(ALL) NOPASSWD: /opt/masjidconnect/deploy/wifi-setup-server.mjs" > "$1/etc/sudoers.d/99-masjidconnect-wifi-setup"
        chmod 440 "$1/etc/sudoers.d/99-masjidconnect-wifi-setup"
      fi
    # Allow first user to run self-update script without password (FORCE_UPDATE from admin portal).
    - |
      U=$(chroot "$1" getent passwd 1000 | cut -d: -f1)
      if [ -n "$U" ]; then
        echo "${U} ALL=(ALL) NOPASSWD: /opt/masjidconnect/deploy/update-from-github.sh" > "$1/etc/sudoers.d/99-masjidconnect-update"
        chmod 440 "$1/etc/sudoers.d/99-masjidconnect-update"
      fi
