#!/usr/bin/env bash
# =============================================================================
# MasjidConnect Kiosk — xinit client script for minimal X11 image.
# Run by xinit as the client after the X server starts (e.g. xinit this-file -- :0 vt1).
# If no internet is detected, shows a WiFi setup GUI before launching the kiosk.
# Disables screen sleep, hides cursor, waits for display server, then launches Chromium.
# =============================================================================

set -euo pipefail

PORT="${PORT:-3001}"
URL="http://localhost:${PORT}"
WIFI_SETUP_PORT="${WIFI_SETUP_PORT:-3002}"
WIFI_SETUP_URL="http://127.0.0.1:${WIFI_SETUP_PORT}"
WIFI_FLAG="/tmp/masjidconnect-wifi-done"

# Log for debugging after reboot: ssh in and run  cat /tmp/kiosk.log
KIOSK_LOG="/tmp/kiosk.log"
log() { echo "$(date '+%Y-%m-%d %H:%M:%S') $*" >> "$KIOSK_LOG" 2>/dev/null || true; }
log "xinitrc-kiosk started (user=$(whoami) DISPLAY=${DISPLAY:-:0})"

# Disable DPMS (screen sleep) and screen saver
xset s off 2>/dev/null || true
xset -dpms 2>/dev/null || true
xset s noblank 2>/dev/null || true

# Hide the mouse cursor after 0.5s of inactivity
if command -v unclutter &>/dev/null; then
  unclutter -idle 0.5 -root &
fi

# ----- Pre-kiosk: if no internet, show WiFi setup GUI (for end users who only have the image) -----
have_connectivity() {
  curl -sf --connect-timeout 4 -o /dev/null "https://portal.masjidconnect.co.uk" 2>/dev/null || \
    ping -c 1 -W 3 8.8.8.8 >/dev/null 2>&1
}

if ! have_connectivity; then
  log "No internet detected — starting WiFi setup"
  rm -f "$WIFI_FLAG"
  WIFI_SERVER_PID=""
  if [ -x "/opt/masjidconnect/deploy/wifi-setup-server.mjs" ] || [ -f "/opt/masjidconnect/deploy/wifi-setup-server.mjs" ]; then
    sudo /opt/masjidconnect/deploy/wifi-setup-server.mjs &
    WIFI_SERVER_PID=$!
    for i in $(seq 1 30); do
      if curl -sf -o /dev/null "${WIFI_SETUP_URL}/api/status" 2>/dev/null; then break; fi
      sleep 0.5
    done
    if curl -sf -o /dev/null "${WIFI_SETUP_URL}/api/status" 2>/dev/null; then
      CHROMIUM=""
      command -v chromium-browser &>/dev/null && CHROMIUM="chromium-browser" || command -v chromium &>/dev/null && CHROMIUM="chromium"
      if [ -n "$CHROMIUM" ]; then
        export DISPLAY="${DISPLAY:-:0}"
        export XAUTHORITY="${HOME:-/tmp}/.Xauthority"
        CHROMIUM_USER_DATA="${HOME:-/tmp}/.config/chromium-wifi-setup"
        mkdir -p "${CHROMIUM_USER_DATA}" 2>/dev/null || true
        env DBUS_SESSION_BUS_ADDRESS= "$CHROMIUM" \
          --start-fullscreen --start-maximized --window-position=0,0 --no-first-run \
          --user-data-dir="${CHROMIUM_USER_DATA}" \
          --noerrdialogs --disable-infobars --disable-sync --password-store=basic \
          "${WIFI_SETUP_URL}" 2>/dev/null || true
      fi
      [ -n "$WIFI_SERVER_PID" ] && kill "$WIFI_SERVER_PID" 2>/dev/null || true
    fi
  fi
  if [ -f "$WIFI_FLAG" ]; then
    log "WiFi setup completed (flag set), waiting for network..."
    for i in $(seq 1 20); do
      sleep 1
      have_connectivity && break
    done
    rm -f "$WIFI_FLAG"
  fi
fi

# Wait for the display server to be ready
for i in $(seq 1 90); do
  if curl -sf "${URL}/health" >/dev/null 2>&1; then
    break
  fi
  sleep 1
done

# Use chromium-browser (Bookworm) or chromium (Trixie)
CHROMIUM=""
if command -v chromium-browser &>/dev/null; then
  CHROMIUM="chromium-browser"
elif command -v chromium &>/dev/null; then
  CHROMIUM="chromium"
else
  echo "[Kiosk] ERROR: Chromium not found." >&2
  exit 1
fi

# At boot we run as pi (xinit was started by pi from .profile). Do NOT use runuser — only root can use it.
export DISPLAY="${DISPLAY:-:0}"
export XAUTHORITY="${HOME:-/tmp}/.Xauthority"

# Detect display size dynamically (any resolution). Prefer xrandr (actual current mode), then xdpyinfo.
WINDOW_SIZE="1920,1080"
if command -v xrandr &>/dev/null; then
  # "Screen 0: ... current 3840 x 2160 ..." or similar
  DIM=$(xrandr --current 2>/dev/null | sed -n 's/.* current \([0-9]*\) x \([0-9]*\).*/\1,\2/p' | head -1)
  if [ -n "$DIM" ] && [ "$DIM" != "," ]; then
    WINDOW_SIZE="$DIM"
  fi
fi
if [ "$WINDOW_SIZE" = "1920,1080" ] && command -v xdpyinfo &>/dev/null; then
  DIM=$(xdpyinfo 2>/dev/null | grep 'dimensions:' | head -1 | awk '{print $2}' | tr 'x' ',')
  [ -n "$DIM" ] && WINDOW_SIZE="$DIM"
fi
log "Display size: $WINDOW_SIZE (--window-size will force fullscreen)"

# Dedicated profile so no sign-in prompts.
CHROMIUM_USER_DATA="${HOME:-/tmp}/.config/chromium-kiosk"
mkdir -p "${CHROMIUM_USER_DATA}" 2>/dev/null || true

# Brief delay so X/DRM is fully ready.
sleep 5

log "Starting Chromium (DISPLAY=$DISPLAY)"

# GPU flags match install.sh/kiosk.sh for better performance (avoids CPU-bound rendering and freezes).
# Set KIOSK_DISABLE_GPU=1 in the environment if you get a black screen and need software rendering.
CHROMIUM_GPU_FLAGS="--enable-gpu-rasterization --enable-oop-rasterization"
[ "${KIOSK_DISABLE_GPU:-0}" = "1" ] && CHROMIUM_GPU_FLAGS="--disable-gpu"

# Launch Chromium in a loop (same user as xinit — no runuser).
while true; do
  env DBUS_SESSION_BUS_ADDRESS= "${CHROMIUM}" \
    --kiosk \
    --start-fullscreen \
    --start-maximized \
    --window-position=0,0 \
    --window-size="${WINDOW_SIZE}" \
    --noerrdialogs \
    --disable-infobars \
    --no-first-run \
    --disable-sync \
    --disable-signin-profile-creation \
    --user-data-dir="${CHROMIUM_USER_DATA}" \
    --check-for-update-interval=31536000 \
    --disable-features=TranslateUI \
    --disable-pinch \
    --overscroll-history-navigation=0 \
    $CHROMIUM_GPU_FLAGS \
    --disable-dev-shm-usage \
    --force-device-scale-factor=1 \
    --autoplay-policy=no-user-gesture-required \
    --disable-session-crashed-bubble \
    --disable-component-update \
    --password-store=basic \
    --renderer-process-limit=1 \
    --disable-background-networking \
    --disable-backgrounding-occluded-windows \
    "${URL}" || true
  log "Chromium exited, restarting in 5s"
  sleep 5
done
